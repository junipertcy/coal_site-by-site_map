<!DOCTYPE html>
<html lang="en" class="gr__slideout_js_org">
<head>
    <meta charset='utf-8'/>
    <title>Japan coal site-by-site map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <script src='node_modules/jquery/dist/jquery.min.js'></script>
    <script src="node_modules/leaflet/dist/leaflet.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>
    <script src='node_modules/@mapbox/leaflet-omnivore/leaflet-omnivore.min.js'></script>

    <script src='node_modules/d3/build/d3.min.js'></script>
    <script src='node_modules/d3-color/build/d3-color.min.js'></script>
    <script src='node_modules/d3-svg-legend/d3-legend.min.js'></script>

    <script src='node_modules/d3-interpolate/build/d3-interpolate.min.js'></script>

    <link href='assets/css/popup.css' rel='stylesheet'/>
    <link href='assets/css/panel.css' rel='stylesheet'/>
    <link href='assets/css/icons.css' rel='stylesheet'/>
    <link href='assets/css/menu.css' rel='stylesheet'/>
    <link href='node_modules/leaflet/dist/leaflet.css' rel='stylesheet'/>

    <script src="assets/js/map_operations.js"></script>
    <script src='node_modules/mapbox-gl/dist/mapbox-gl.js'></script>
    <link href='node_modules/mapbox-gl/dist/mapbox-gl.css' rel='stylesheet'/>
    <script src='assets/js/mapbox-gl-language.js'></script>
    <script src='assets/js/coal_plant_listings.js'></script>
    <script src='assets/js/map_style.js'></script>

    <script src='assets/js/semantic/dist/semantic.min.js'></script>
    <script src='node_modules/watchjs/src/watch.min.js'></script>
    <!--<link href='assets/css/test/styles.css' rel='stylesheet'>-->
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>

    <link href='assets/js/semantic/dist/semantic.min.css' rel='stylesheet'>
    <link href='assets/css/slider.css' rel='stylesheet'>
    <link href='assets/css/cartodb.css' rel='stylesheet'>
    <link href="assets/css/splashOverlay.css" rel="stylesheet">
    <link href="node_modules/font-awesome/css/font-awesome.min.css" rel="stylesheet">

</head>
<body>


<script>
    // let is_play = false;
    // let month = 0;
    // let _layerName = '';
    // let _id;
    // let _pollutant;

    let isSlideOut = false;
    let state = {
        is_play: false,
        isPollutantSelected: false,
        month: 0,
        _layerName: '',
        _id: '',
        _pollutant: '',
        availableSources: {
            "no2": new Set(),
            "pm25": new Set(),
            "so2": new Set()
        },
        existingLayers: new Set(),
        activeLayers: new Set(),
        max_concentration: 0
    };

    async function downloadSources(activeLayers) {
        for (let layer of activeLayers) {
            if (!state.availableSources[state._pollutant].has(layer)) {
                await downloadSource(layer, state._pollutant, function () {
                });
            }
        }

    }

    function showActiveLayers(activeLayers) {

        console.log('max_concentration = ', state.max_concentration);
        state.existingLayers.forEach(function (o) {
            map.removeLayer(o);
        });
        state.existingLayers = new Set();
        for (let layer of activeLayers) {
            map.addLayer({
                'id': state._pollutant + "_" + layer + "_layer",
                'type': 'fill',
                "interactive": true,
                'source': state._pollutant + "_" + layer,
                'paint': {
                    'fill-color': {"type": "identity", "property": "color"},
                    'fill-opacity': 0.5,
                    'fill-outline-color': "white"
                }
            });
            state.existingLayers.add(state._pollutant + "_" + layer + "_layer");
            filterBy(0, state._pollutant + "_" + layer + "_layer");  // January
            document.getElementById('slider').addEventListener('input', function (e) {
                let month = parseInt(e.target.value);
                filterBy(month, state._pollutant + "_" + layer + "_layer");
            });
        }
        drawLegend(state.max_concentration);
    }

    //defining a 'watcher' for an attribute
    watch(state, ["_pollutant"], function () {
        console.log("_pollutant changed: ", state._pollutant);
        let isLayerChecked = $('div').find('input');
        let checkedLayer;
        state.max_concentration = 0;
        if (isLayerChecked.is(':checked')) {
            checkedLayer = _.filter(isLayerChecked, function (o) {
                return o.checked;
            });
            console.log(checkedLayer);

            let activeLayers = _.map(checkedLayer, 'name');
            if (state._pollutant !== "") {
                downloadSources(activeLayers);
                $('body').css('cursor', 'progress');
                setTimeout(function () {
                    showActiveLayers(activeLayers);
                    $('body').css('cursor', 'default');
                    $(".cartodb-timeslider").show();
                }, 3000);
            }

        } else {
            showActiveLayers([]);
            $(".cartodb-timeslider").hide();
            d3.selectAll('svg').remove();
        }
    });
</script>

<script>
    let timer;

    function play(layerNames) {
        // $('#listing' + '-' + state._id).addClass('active');
        if (!state.is_play) {
            $('#play_button').removeClass('fa fa-play fa-lg').addClass('fa fa-pause fa-lg');
            timer = setInterval(function () {
                $("input[type='range']")[0].value = (state.month % 12).toString();
                layerNames.forEach(function (o) {
                    filterBy(state.month % 12, o);
                });
                state.month += 1;
            }, 500);
        } else {
            $('#play_button').removeClass('fa fa-pause fa-lg').addClass('fa fa-play fa-lg');
            clearInterval(timer);
        }
        state.is_play = !state.is_play;
    }

    function sync() {
        let isLayerChecked = $('div').find('input');
        let checkedLayer;
        state.max_concentration = 0;

        if (isLayerChecked.is(':checked')) {
            checkedLayer = _.filter(isLayerChecked, function (o) {
                return o.checked;
            });

            let activeLayers = _.map(checkedLayer, 'name');
            console.log(activeLayers);
            if (state._pollutant !== "") {
                downloadSources(activeLayers);
                $('body').css('cursor', 'progress');
                setTimeout(function () {
                    showActiveLayers(activeLayers);
                    $('body').css('cursor', 'default');
                    $(".cartodb-timeslider").show();
                }, 3000);
            }
        } else {
            showActiveLayers([]);
            $(".cartodb-timeslider").hide();
            d3.selectAll('svg').remove();
        }
    }
</script>


<nav id="menu" style="display:none;">
    <div class="header">
        <hr>
        <h3 class="apptitle">Coal site-by-site map</h3>
        <div id="helpbar">
            <button class="ui mini right labeled icon violet button" style="width: 120px;"><i class="icon info"></i>
                これは何ですか？
            </button>
            &nbsp;
            <button class="ui mini right labeled icon violet button" style="width: 120px;"><i
                    class="icon right arrow"></i>
                もっと詳しく知る
            </button>
            <hr>

        </div>
        <div id="picker">
            <h5>CHOOSE A POLLUTANT:</h5>
            <button class="mini ui inverted green icon toggle button"
                    onclick="selectPollutant('no2');">
                <i class="icon asterisk" id="no2_button"></i>
                NO2
            </button>
            <button class="mini ui inverted green icon toggle button"
                    onclick="selectPollutant('so2');">
                <i class="icon asterisk" id="so2_button"></i>
                SO2
            </button>
            <button class="mini ui inverted green icon toggle button"
                    onclick="selectPollutant('pm25');">
                <i class="icon asterisk" id="pm25_button"></i>
                PM2.5
            </button>
            <button class="mini ui inverted blue icon toggle button" onclick="sync();">
                <i class="sync alternate icon" id="update_button"></i>
                更新
            </button>
        </div>
    </div>
    <div id='listings' class='listings'></div>
    <div class='logo'></div>
</nav>

<main id="panel">
    <button class="toggle-button" id="slider-button">☰</button>
    <div id="bottomRight">
        <div><a href="" target="_blank" style="color: ghostwhite; font-weight: bold;">Greenpeace Japan</a></div>
        <div style="color: ghostwhite;">Source: TO_BE_FILLED</div>
    </div>
    <div class="mapbox-attribution-container">
        <a href="https://www.mapbox.com/about/maps/" style="color: ghostwhite;">© Mapbox | </a>
        <a href="https://www.openstreetmap.org/copyright" style="color: ghostwhite;">© OpenStreetMap</a>
        <!--<a href="" target="_blank"><strong>Improve this map</strong></a>-->
    </div>

    <!--<div id='legend' class='legend'>-->
    <!--<div style="font-weight: bold; color: white;">濃度 (ppm)</div>-->
    <!--</div>-->

    <!--<br> <h5 style="margin-top: 10px;">NO2 排出量（t / 年）：</h5>-->
    <!--<div style="position: absolute; width: 40px;">-->
    <!--<label id='month' style="color: white;"></label>-->
    <!--</div>-->
    <!--<input id='slider' style="margin-left: 40px;" type='range' min='0' max='11' step='1' value='0'/>-->

    <div class="cartodb-timeslider" style="width: 200px; top: 10px; right: 50px; display:none;">
        <ul>
            <li class="controls" style="cursor:pointer" onclick="play(state.existingLayers);">
                <i class="fa fa-play fa-lg" style="margin-left: 20px; position: absolute; margin-top: 13px;"
                   id="play_button"></i>
            </li>
            <li class="time"><p id="month" class="value"></p></li>
            <li class="last">
                <input id='slider' style="margin-left: 15px;" type='range' min='0' max='11' step='1' value='0'/>
            </li>
        </ul>
    </div>
</main>
<script src="node_modules/slideout/dist/slideout.js"></script>

<script>
    let slideout = new Slideout({
        'panel': document.getElementById('panel'),
        'menu': document.getElementById('menu'),
        'padding': 300,
        'tolerance': 70,
        'touch': false
    });
    // Toggle button
    document.querySelector('.toggle-button').addEventListener('click', function () {
        slideout.toggle();
        isSlideOut = !isSlideOut;
        if (isSlideOut) {
            $('#menu').show();
            // $('.mapboxgl-ctrl-top-right').css('transition-timing-function', 'linear').css('right', '300px');
            // $('.mapbox-attribution-container').css('transition-timing-function', 'linear').css('right', '300px');
            // $('.cartodb-timeslider').css('transition-timing-function', 'linear').css('right', '350px');
            // $('#bottomRight').css('transition-timing-function', 'linear').css('right', '300px');
            $('#panel').css('transition-timing-function', 'linear').css('right', '300px');
            $('#slider-button').css('transition-timing-function', 'linear').css('left', '310px');
            $('.mapboxgl-ctrl-bottom-left').css('left', '300px');
            $('.mapboxgl-popup-content').css('left', '310px');
            d3.select('svg').style('left', '350px');
        } else {
            // $('#menu').hide();
            // $('.mapboxgl-ctrl-top-right').css('right', '0px');
            // $('.mapbox-attribution-container').css('right', '0px');
            // $('.cartodb-timeslider').css('transition-timing-function', 'linear').css('right', '50px');
            // $('#bottomRight').css('transition-timing-function', 'linear').css('right', '0px');
            $('#panel').css('transition-timing-function', 'linear').css('right', '0');
            $('#slider-button').css('transition-timing-function', 'linear').css('left', '10px');
            $('.mapboxgl-ctrl-bottom-left').css('left', '0px');
            $('.mapboxgl-popup-content').css('left', '10px');
            d3.select('svg').style('left', '50px');
        }
    });

</script>

<!--<div id="propertyInfoSection" class="bottomLeftSection" style="display: block; position:absolute;">-->
        <!--<table>-->
            <!--<tbody>-->
            <!--<tr>-->
                <!--<td>Address</td>-->
                <!--<td>-->
                    <!--<div id="selectedPropertyAddress">801 W 22ND AV</div>-->
                    <!--<a href="https://www.google.com/maps/place/801 W 22ND AV, Vancouver, BC/data=!3m1!1e3"-->
                       <!--id="selectedPropertyMapsLink" class="button lineForGoogleMaps" target="_blank"-->
                       <!--style="display: inline-block;">On Google Maps</a><label for="chkShowTutorial3DOverlay">-->
                    <!--<div class="buttonForTutorial3d lineForGoogleMaps" style="display: inline-block;">See in 3D <i-->
                            <!--class="fa fa-question-circle-o fa-fw" aria-hidden="true"></i></div>-->
                <!--</label></td>-->
            <!--</tr>-->
            <!--<tr>-->
                <!--<td>Assessment</td>-->
                <!--<td id="selectedPropertyAssessment">$87,780,900</td>-->
            <!--</tr>-->
            <!--</tbody>-->
        <!--</table>-->
<!--</div>-->


<script>
    function selectPollutant(pollutant) {
        state._pollutant = pollutant;
        $('#' + pollutant + '_button').parent().addClass('active').siblings().removeClass('active');
        // if ((isButtonClicked && !state.isPollutantSelected) || (!isButtonClicked && state.isPollutantSelected)) {
        //     state._pollutant = pollutant;
        //     $('#' + pollutant + '_button').parent().addClass('active').siblings().removeClass('active');
        // } else if (isButtonClicked && state.isPollutantSelected || (!isButtonClicked && state.isPollutantSelected === "")) {
        //     $('#' + pollutant + '_button').parent().removeClass('active');
        //     state._pollutant = "";
        // }
        // if (isButtonClicked) {
        //     state.isPollutantSelected = !state.isPollutantSelected;
        // }
    }

</script>


<script>
    let months = [
        '1 月',
        '2 月',
        '3 月',
        '4 月',
        '5 月',
        '6 月',
        '7 月',
        '8 月',
        '9 月',
        '10 月',
        '11 月',
        '12 月'
    ];

    function filterBy(month, layerName) {
        let filters = ['==', 'month', month];
        map.setFilter(layerName, filters);
        document.getElementById('month').textContent = months[month];
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoianVuaXBlcnRjeSIsImEiOiJvOFg5WFVjIn0.7NDB1oOLpq3A5qO7vLaQSA';

    let map = new mapboxgl.Map({
        container: 'panel',
        style: style,
        center: [135.43366015639952, 38.37210580471424],
        zoom: 5,
        doubleClickZoom: false,
        dragRotate: false,
        touchZoomRotate: true
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({
        maxWidth: 160,
        unit: 'metric'
    }));


    map.on('click', function (e) {
        selectPollutant(state._pollutant);
        console.log(e);
    });

    // Holds visible plant features for filtering
    let _plants = [];
    // Create a popup, but don't add it to the map yet.
    let _little_popup = new mapboxgl.Popup({
        closeButton: false
    });

    let filterEl = document.getElementById('feature-filter');
    let listingEl = document.getElementById('feature-listing');

    // Map interactions
    map.on('sourcedata', function (sourcedata) {
        if (sourcedata.isSourceLoaded) {
            map.setMinZoom(3);
            map.setMaxZoom(16);

            map.on('mouseenter', 'points', function () {
                // console.log("mouseenter events detected!");
                map.getCanvas().style.cursor = 'pointer';
            });
            // console.log("mouseenter events defined!");
            map.on('mouseleave', 'points', function () {
                map.getCanvas().style.cursor = '';
            });

            map.on('click', function (e) {
                // console.log("You clicked the icon!");
                let features = map.queryRenderedFeatures(e.point, {layers: ['points']});
                if (features.length) {
                    let clickedPoint = features[0];
                    flyToStore(clickedPoint);
                    createPopUp(clickedPoint);
                    let activeItem = document.getElementsByClassName('active');
                    if (activeItem[0]) {
                        activeItem[0].classList.remove('active');
                    }
                    let selectedFeature = clickedPoint.properties.id;

                    for (let i = 0; i < plants.features.length; i++) {
                        if (plants.features[i].properties.id === selectedFeature) {
                            selectedFeatureIndex = i;
                        }
                    }
                    let listing = document.getElementById('listing-' + selectedFeatureIndex);
                    listing.classList.add('active');
                }
            });
        }
    });

    map.loadImage('assets/css/img/factoryTransp3.png', function (error, image) {
        if (error) throw error;
        map.addImage('industry', image);
        map.addLayer({
            "id": "points",
            "type": "symbol",
            "interactive": true,
            "source": {
                "type": "geojson",
                "data": plants
            },
            "layout": {
                "icon-image": "industry",
                "icon-size": 0.08,
                'icon-ignore-placement': true,
                'icon-allow-overlap': true
            }
        });
        map.loadImage('assets/css/img/factoryTransp3_red.png', function (error, image) {
            map.addImage('industry_red', image);
            map.addLayer({
                "id": "points-hover",
                "type": "symbol",
                "interactive": true,
                "source": {
                    "type": "geojson",
                    "data": plants
                },

                "filter": ["==", "name", ""],
                "layout": {
                    "icon-image": "industry_red",
                    "icon-size": 0.08,
                    'icon-ignore-placement': true,
                    'icon-allow-overlap': true
                }
            });
            map.on("mousemove", "points", function (e) {
                map.setFilter("points-hover", ["==", "name", e.features[0].properties.name]);
            });
            // Reset the state-fills-hover layer's filter when the mouse leaves the layer.
            map.on("mouseleave", "points", function () {
                map.setFilter("points-hover", ["==", "name", ""]);
            });
        });
    });
    buildLocationList(plants);

</script>
<!--<script src="assets/js/sidebar_handler.js"></script>-->
<script>
    function drawLegend(max) {
        d3.selectAll('svg').remove();
        d3.select('#panel').append('svg');
        let sequentialScale = d3.scaleSequential(d3.interpolateLab("#ec7014", "#662506"))
            .domain([0, max]);

        let svg = d3.select("svg")
            .style("background", "white")
            .style("opacity", 0.9)
            .style("border-radius", "25px")
            .style("border", "2px solid #73AD21");

        svg.append("g")
            .attr("class", "legendSequential")
            .attr("transform", "translate(20,20)");

        let legendSequential = d3.legendColor()
            .shapeWidth(30)
            .cells(4)
            .orient("vertical")
            .scale(sequentialScale)
            .title("濃度 (ppm)");

        svg.select(".legendSequential")
            .call(legendSequential);
        svg.style('left', '350px');
    }
</script>


<!--<div id="splashOverlay" class="fullScreenOverlay">-->
<!--<div id="splashFloat" style="visibility: visible; opacity: 1;">-->
<!--<div id="regionSelectorFloat" style="display: none;"><h1>Select a City to View Assessments</h1> <a-->
<!--href="http://yvr-assess.dha.io/">-->
<!--<div class="regionSelection"><h2>Vancouver</h2><img src="assets/images/regions/yvr-region-160x160.jpg">-->
<!--<div>Ranked 3rd Least Affordable Housing Market in the World</div>-->
<!--</div>-->
<!--</a><a href="http://sfo-assess.dha.io/">-->
<!--<div class="regionSelection"><h2>San Francisco</h2><img src="assets/images/regions/sfo-region-160x160.jpg">-->
<!--<div>Ranked 9th Least Affordable Housing Market in the World</div>-->
<!--</div>-->
<!--</a><a href="http://yeg-assess.dha.io/">-->
<!--<div class="regionSelection isLast"><h2>Edmonton</h2><img-->
<!--src="assets/images/regions/yeg-region-160x160.jpg">-->
<!--<div>Median Residential Assessment of $322,000 CAD ($239,450 USD)</div>-->
<!--</div>-->
<!--</a></div> &lt;!&ndash; <video controls autoplay>-->
<!--<source src="assets/videos/3d_mode_instructions_canada_place.webm" type="video/webm">-->
<!--Your browser does not support the video tag.-->
<!--</video> &ndash;&gt;-->
<!--<div id="regionSplashScreen">-->
<!--<h1>A Look at Property Assessments in <label for="chkShowCitiesDropdown"><span-->
<!--class="region">Edmonton</span><i class="fa fa-caret-down fa-fw"></i></label>-->
<!--<div class="regionsDropdown"><a href="http://yvr-assess.dha.io/">-->
<!--<div class="regionOption">-->
<!--<div>Vancouver</div>-->
<!--<div class="shortLine">Ranked 3rd Least Affordable Housing Market in the World</div>-->
<!--</div>-->
<!--</a><a href="http://sfo-assess.dha.io/">-->
<!--<div class="regionOption isLast">-->
<!--<div>San Francisco</div>-->
<!--<div class="shortLine">Ranked 9th Least Affordable Housing Market in the World</div>-->
<!--</div>-->
<!--</a></div>-->
<!--</h1>-->
<!--<p class="regionIntroParagraph">Where can I afford to buy a house? Compared to my neighbours, am I paying-->
<!--more property tax? Are there patterns that dramatically affect a house's assessment value?</p>-->
<!--<p>This interactive map helps you answer these questions. Get started with some stories, or skip them to-->
<!--zoom in and click on a property.</p>-->
<!--<div class="buttonSection isOutdated" style="display: none;">-->
<!--<div class="button error"><i class="fa fa-exclamation-triangle fa-fw" aria-hidden="true"></i>-->
<!--Incompatible with your Browser-->
<!--</div>-->
<!--<div class="buttonMessage">* This visualization needs hardware acceleration that your browser doesn't-->
<!--support. Please upgrade your browser, or view this with Chrome/Firefox on your computer.-->
<!--</div>-->
<!--</div>-->
<!--<div class="buttonSection isIE" style="display: none;">-->
<!--<div class="button error"><i class="fa fa-exclamation-triangle fa-fw" aria-hidden="true"></i>-->
<!--Incompatible with IE or Edge-->
<!--</div>-->
<!--<div class="buttonMessage">* This visualization runs <i>much slower</i> on IE/Edge, but works great with-->
<!--Chrome or Firefox. Please use one of those browsers.-->
<!--</div>-->
<!--</div>-->
<!--<div class="buttonSection noWebGL" style="display: none;">-->
<!--<div class="button error"><i class="fa fa-exclamation-triangle fa-fw" aria-hidden="true"></i> Browser-->
<!--Does Not Support WebGL-->
<!--</div>-->
<!--<div class="buttonMessage">* This visualization needs hardware acceleration that your browser doesn't-->
<!--support. Please make sure your browser supports, and has "WebGL" turned on.-->
<!--</div>-->
<!--</div>-->
<!--&lt;!&ndash; <div class='button caution'><i class="fa fa-exclamation-circle fa-fw" aria-hidden="true"></i> Performance better on a computer</div> &ndash;&gt;-->
<!--<div class="buttonSection isMobileOrTablet" style="display: none;"><label for="chkSplashShowStories">-->
<!--<div class="button caution splash showStories"><i class="fa fa-exclamation-circle fa-fw"-->
<!--aria-hidden="true"></i> Try visualization on this-->
<!--device (might be slow or not work)-->
<!--</div>-->
<!--</label>-->
<!--<div class="buttonMessage">* This visualization will work on your device if it's newer. If it's too-->
<!--slow, please try it on a computer! It's a map visualization, which would look better on a bigger-->
<!--screen anyhow, and 3D buildings will show up there too.-->
<!--</div>-->
<!--</div>-->
<!--<div class="buttonSection isDefault" style="display: block;"><label for="chkSplashShowStories">-->
<!--<div class="button splash showStories">Stories in the Data</div>-->
<!--</label> <span>or</span> <label for="chkSplashSkipStories">-->
<!--<div class="button splash skipStories">Skip Stories</div>-->
<!--</label></div>-->
<!--<p class="note">NOTE: Property assessments are not what houses sell for. They can, however, offer clues on-->
<!--where affordable housing can be found. Assessments are based on many factors, not just location. Does a-->
<!--house have a garage? A furnished basement? Air conditioning? How old is it? </p></div>-->
<!--</div>-->
<!--</div>-->


</body>
</html>