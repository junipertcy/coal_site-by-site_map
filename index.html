<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'/>
    <title>Japan coal site-by-site map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <script src='node_modules/jquery/dist/jquery.min.js'></script>
    <script src="node_modules/leaflet/dist/leaflet.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>
    <script src='node_modules/mapbox-gl/dist/mapbox-gl.js'></script>
    <script src='node_modules/@mapbox/leaflet-omnivore/leaflet-omnivore.min.js'></script>
    <script src='node_modules/watchjs/src/watch.min.js'></script>
    <script src="node_modules/slideout/dist/slideout.js"></script>

    <script src='node_modules/d3/build/d3.min.js'></script>
    <script src='node_modules/d3-color/build/d3-color.min.js'></script>
    <script src='node_modules/d3-svg-legend/d3-legend.min.js'></script>
    <script src='node_modules/d3-interpolate/build/d3-interpolate.min.js'></script>


    <script src="assets/js/map_operations.js"></script>
    <script src='assets/js/mapbox-gl-language.js'></script>
    <script src='assets/js/coal_plant_listings.js'></script>
    <script src='assets/js/map_style.js'></script>
    <script src='assets/js/semantic/dist/semantic.min.js'></script>

    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
    <link href='node_modules/leaflet/dist/leaflet.css' rel='stylesheet'/>
    <link href='node_modules/mapbox-gl/dist/mapbox-gl.css' rel='stylesheet'/>
    <link href="node_modules/font-awesome/css/font-awesome.min.css" rel="stylesheet">

    <link href='assets/js/semantic/dist/semantic.min.css' rel='stylesheet'>
    <link href='assets/css/slider.css' rel='stylesheet'>
    <link href='assets/css/cartodb.css' rel='stylesheet'>
    <link href="assets/css/splashOverlay.css" rel="stylesheet">
    <link href='assets/css/popup.css' rel='stylesheet'/>
    <link href='assets/css/mapControls.css' rel='stylesheet'/>
    <link href='assets/css/icons.css' rel='stylesheet'/>

</head>
<body>

<script src="assets/js/higherInteraction.js"></script>
<script src="assets/js/playAndSync.js"></script>
<script src="assets/js/selectPollutant.js"></script>
<script src='assets/js/drawLegend.js'></script>

<div style="width: 270px;
    position: absolute;
    top: 10px;
    right: 49px;
    z-index: 10000;
    background: white;
    padding: 10px;
    border-radius: 5px;
    height: 81px; display: none;" id="picker">
    <h5>CHOOSE A POLLUTANT:</h5>
    <button class="mini ui inverted green icon toggle button"
            onclick="selectPollutant('no2');">
        <i class="icon asterisk" id="no2_button"></i>
        NO2
    </button>
    <button class="mini ui inverted green icon toggle button"
            onclick="selectPollutant('so2');">
        <i class="icon asterisk" id="so2_button"></i>
        SO2
    </button>
    <button class="mini ui inverted green icon toggle button"
            onclick="selectPollutant('pm25');">
        <i class="icon asterisk" id="pm25_button"></i>
        PM2.5
    </button>
    <button class="mini ui inverted blue icon toggle button" onclick="sync();">
        <i class="sync alternate icon" id="update_button"></i>
        更新
    </button>
</div>

<main id="mapControls">
    <div id="bottomRight">
        <div><a href="http://www.greenpeace.org/japan/ja/" target="_blank"
                style="color: ghostwhite; font-weight: bold;">Greenpeace Japan</a></div>
        <div style="color: ghostwhite;">Source: TO_BE_FILLED</div>
    </div>
    <div class="mapbox-attribution-container">
        <a href="https://www.mapbox.com/about/maps/" style="color: ghostwhite;">© Mapbox | </a>
        <a href="https://www.openstreetmap.org/copyright" style="color: ghostwhite;">© OpenStreetMap</a>
    </div>

    <div class="cartodb-timeslider" style="width: 200px; top: 10px; right: 50px; display:none;">
        <ul>
            <li class="controls" style="cursor:pointer" onclick="play(state.existingLayers);">
                <i class="fa fa-play fa-lg" style="margin-left: 20px; position: absolute; margin-top: 13px;"
                   id="play_button"></i>
            </li>
            <li class="time"><p id="month" class="value"></p></li>
            <li class="last">
                <input id='slider' style="margin-left: 15px;" type='range' min='0' max='11' step='1' value='0'/>
            </li>
        </ul>
    </div>
</main>

<div class="title">
    <div id="title_content">Hover to a coal plant.</div>
    <div class="titleHideButton">
        <i class="fa fa-minus-square"></i>
    </div>
</div>
<div class="instruction">
    <i class="fa fa-angle-double-right" id="instruction_content"> Click for more info.</i>

</div>


<script>
    let slideout = new Slideout({
        'panel': document.getElementById('mapControls'),
        'menu': document.getElementById(''),
        'padding': 300,
        'tolerance': 70,
        'touch': false
    });

</script>

<script>
    let months = [
        '1 月',
        '2 月',
        '3 月',
        '4 月',
        '5 月',
        '6 月',
        '7 月',
        '8 月',
        '9 月',
        '10 月',
        '11 月',
        '12 月'
    ];

    function filterBy(month, layerName) {
        let filters = ['==', 'month', month];
        map.setFilter(layerName, filters);
        document.getElementById('month').textContent = months[month];
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoianVuaXBlcnRjeSIsImEiOiJvOFg5WFVjIn0.7NDB1oOLpq3A5qO7vLaQSA';

    let map = new mapboxgl.Map({
        container: 'mapControls',
        style: style,
        center: [135.43366015639952, 38.37210580471424],
        zoom: 5,
        doubleClickZoom: false,
        dragRotate: false,
        touchZoomRotate: true
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({
        maxWidth: 160,
        unit: 'metric'
    }));

    // Map interactions
    let isSourceLoadedPoints = false;
    map.on('sourcedata', function (sourcedata) {
        if (sourcedata.isSourceLoaded) {
            map.setMinZoom(3);
            map.setMaxZoom(16);
            if (!isSourceLoadedPoints) {
                isSourceLoadedPoints = !isSourceLoadedPoints;
                map.loadImage('assets/css/img/factoryTransp3_selected.png', function (error, image) {
                    if (error) throw error;
                    map.addImage('industry', image);
                    map.addLayer({
                        "id": "points",
                        "type": "symbol",
                        "interactive": true,
                        "source": {
                            "type": "geojson",
                            "data": plants
                        },
                        "layout": {
                            "icon-image": "industry",
                            "icon-size": 0.08,
                            'icon-ignore-placement': true,
                            'icon-allow-overlap': true
                        }
                    });
                    map.loadImage('assets/css/img/factoryTransp3.png', function (error, image) {
                        map.addImage('industry_red', image);
                        map.addLayer({
                            "id": "points-hover",
                            "type": "symbol",
                            "interactive": true,
                            "source": {
                                "type": "geojson",
                                "data": plants
                            },
                            "filter": ["==", "name", ""],
                            "layout": {
                                "icon-image": "industry_red",
                                "icon-size": 0.08,
                                'icon-ignore-placement': true,
                                'icon-allow-overlap': true
                            }
                        });
                        map.loadImage('assets/css/img/factoryTransp3_red.png', function (error, image) {
                            map.addImage('industry_selected', image);
                            map.addLayer({
                                "id": "points-dblclick",
                                "type": "symbol",
                                "interactive": true,
                                "source": {
                                    "type": "geojson",
                                    "data": plants
                                },
                                "filter": ["==", "name", ""],
                                "layout": {
                                    "icon-image": "industry_selected",
                                    "icon-size": 0.08,
                                    'icon-ignore-placement': true,
                                    'icon-allow-overlap': true
                                }
                            });

                            // Add other map event listeners here:
                            map.on("mousemove", "points", function (e) {
                                map.getCanvas().style.cursor = 'pointer';
                                // map.setFilter("points-hover", ["==", "name", e.features[0].properties.name]);
                                d3.select('.title').style('display', 'block');
                                d3.select('.instruction').style('display', 'block');
                                if (state.activeListings.length === 0) {
                                    d3.select('.title').select('#title_content').style('display', "block").text(e.features[0].properties.name);
                                    d3.select('.instruction').select('#instruction_content').style('display', "block").text(' Click for more info.');
                                } else {
                                    d3.select('.title').select('#title_content').style('display', "block").text('Select a new coal plant.');
                                    d3.select('.instruction').select('#instruction_content').style('display', "block").text(' Click to update the info window.');
                                }

                            });
                            map.on("mouseleave", "points", function (e) {
                                map.getCanvas().style.cursor = '';
                                if (state.activeListings.length === 0) {
                                    // d3.select('.title').style('display', "none");
                                    // d3.select('.instruction').style('display', "none");
                                }
                            });

                            map.on('click', function (e) {
                                // Rule 1: At any time, there is one and only one activeListings.
                                let features = map.queryRenderedFeatures(e.point, {layers: ['points']});

                                state.activeListings.pop();

                                if (features.length) {
                                    d3.select('.title').select('#title_content').style('display', "block").text(features[0].properties.name);
                                    d3.select('.instruction').select('#instruction_content').style('display', "block").text('  double click for the pollution layers');
                                    state.activeListings.push(features[0].properties.name);
                                    let clickedPoint = features[0];
                                    flyToStore(clickedPoint);
                                    createPopUp(clickedPoint);
                                } else {
                                    console.log('clicked map, but not on a icon.');
                                }

                                if (state.activeListings.length === 0) {
                                    map.setFilter("points-hover", ["==", "name", ""]);
                                } else {
                                    map.setFilter("points-hover", ["==", "name", features[0].properties.name]);
                                }
                            });
                            map.on('dblclick', function (e) {
                                let features = map.queryRenderedFeatures(e.point, {layers: ['points']});
                                // map.setFilter("points-dblclick", ["==", "name", features[0].properties.name]);
                                d3.select('#picker').style('display', 'block');
                                d3.select('.cartodb-timeslider').style('display', 'none');
                                features.forEach(function(f) {
                                    console.log(f.properties);
                                    if (state.activePlantIds.has(f.properties.id.slice(2))) {
                                        state.activeClusterIds.delete(f.properties.cluster);
                                        state.activePlantIds.delete(f.properties.id.slice(2));
                                        let index = 0;
                                        state.activeNames.forEach(function(name){
                                            console.log('===== in the forEach =====');
                                            console.log('name is', name);
                                            console.log('f.properties.name is', f.properties.name);
                                            if (name === f.properties.name) {
                                                delete state.activeNames[index];
                                            }
                                            // state.activeNames.shift();
                                            state.activeNames = Array.from(new Set(state.activeNames));
                                            index += 1;
                                        });
                                    } else {
                                        state.activeClusterIds.add(f.properties.cluster);
                                        state.activePlantIds.add(f.properties.id.slice(2));
                                        state.activeNames.push(f.properties.name);
                                    }
                                });
                                state.sizeActiveClusterIds = state.activeClusterIds.size;


                                if (state.activeClusterIds.size === 0) {

                                } else {

                                }

                            });
                        });

                    });
                });
            }
        }
    });
</script>


</body>
</html>