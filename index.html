<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'/>
    <title>Japan coal site-by-site map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <script src='node_modules/jquery/dist/jquery.min.js'></script>
    <script src="node_modules/leaflet/dist/leaflet.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>
    <script src='node_modules/mapbox-gl/dist/mapbox-gl.js'></script>
    <script src='node_modules/@mapbox/leaflet-omnivore/leaflet-omnivore.min.js'></script>
    <script src='node_modules/watchjs/src/watch.min.js'></script>

    <!-- Store max value for rendering legends of different layer combinations -->
    <script src="node_modules/object-hash/dist/object_hash.js"></script>

    <script src='node_modules/d3/build/d3.min.js'></script>
    <script src='node_modules/d3-color/build/d3-color.min.js'></script>
    <script src='node_modules/d3-svg-legend/d3-legend.min.js'></script>
    <script src='node_modules/d3-interpolate/build/d3-interpolate.min.js'></script>


    <script src='assets/js/coal_plant_listings_.js'></script>
    <script src='assets/js/map_style.js'></script>

    <link href='assets/css/popup.css' rel='stylesheet'/>
    <link href='assets/css/mapControls.css' rel='stylesheet'/>
    <link href="assets/css/Font-Awesome/web-fonts-with-css/css/fontawesome-all.min.css" rel="stylesheet">


    <script src='assets/js/semantic/dist/semantic.min.js'></script>
    <link href='assets/js/semantic/dist/semantic.min.css' rel='stylesheet'>
    <link href='node_modules/mapbox-gl/dist/mapbox-gl.css' rel='stylesheet'/>


</head>
<body>


<div style="position: absolute; top: 1vh; right: 1vw; z-index: 10000; background: white; padding: 5px; border-radius: 5px;"
     id="picker">
    <div class="ui mini basic icon buttons">
        <button class="ui button left attached" onclick="selectPollutant('pm25');" id="pm25_button"><i>PM2.5</i>
        </button>
        <button class="ui button left attached" onclick="selectPollutant('no2');" id="no2_button"><i>NO<sub>2</sub></i>
        </button>
        <button class="ui button left attached" onclick="selectPollutant('so2');" id="so2_button"><i>SO<sub>2</sub></i>
        </button>
        <button class="ui button left attached" id="select_all_plants" onclick="dblClickAll();"
                data-tooltip="全ての発電所をえらぶ" data-position="bottom center"><i
                class="fa fa-industry"></i></button>
        <button class="ui button right attached" id="show_info_window"
                onclick="showInfoWindow(state.activeListings[0]);" data-tooltip="くわしく見る" data-position="bottom center">
            <i
                    class="fa fa-info"></i></button>
        <button class="ui button right attached" onclick="redo();" data-tooltip="選択を解除する" data-position="bottom center">
            <i class="fa fa-redo-alt"></i></button>
        <button class="ui compact labeled icon button right attached" onclick="play(state.existingLayers);"
                onmouseenter="playOnMouseover()" id="_play_button">
            <i class="play icon" id="play_button"></i>
            <span id="month">石炭火力発電所をえらぶ</span>
        </button>
    </div>

</div>

<!--汚染物質を選択-->
<main id="mapControls">
    <div class="mapbox-attribution-container">
        <a href="https://www.mapbox.com/about/maps/" target="_blank">© Mapbox | </a>
        <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap | </a>
        <a href="http://www.greenpeace.org/japan/ja/" target="_blank">© Greenpeace Japan</a>
    </div>
</main>

<div class="titleContainer" style="display: none;"></div>
<!--<div class="ui grid" style="width: 378px; height: 70px;" id="toggleContent">-->
<!--<div class="sixteen column row">-->
<!--<div class="fourteen wide column" id="title_content">発電所アイコンの上にマウスをのせる</div>-->
<!--<div class="one floated column" style="z-index: 1000;" onmouseenter="d3.select(this).style('cursor', 'pointer');" onmouseleave="d3.select(this).style('cursor', 'default');" onclick="toogleTitleContent();"><i class="fa fa-minus-square" id="toggleInstructionIcon"></i></div>-->
<!--</div>-->
<!--<div class="row" style="font-size: 11px; bottom: 25px;">-->
<!--<div class="one wide column"></div>-->
<!--<div class="fourteen wide column"><i class="fa fa-angle-double-right" id="instruction_content"> アイコンをクリックして詳細を表示</i></div>-->
<!--</div>-->
<!--</div>-->

<script>
    var isDBLClick = false;
    var state = {
        is_play: false,
        isToggleOpen: true,
        isPollutantSelected: false,
        month: 0,
        _layerName: '',
        _id: '',
        _pollutant: '',
        availableSources: {
            "no2": new Set(),
            "pm25": new Set(),
            "so2": new Set()
        },
        existingLayers: new Set(),
        activeClusterIds: new Set(),
        activePlantIds: new Set(),
        activeNames: [],
        sizeActiveClusterIds: 0,  // ac-hoc usage for the watch function
        maxConcentrationDict: {},
        activeListings: [],
        maxValue: {}
    };


    let months = [
        '1 月',
        '2 月',
        '3 月',
        '4 月',
        '5 月',
        '6 月',
        '7 月',
        '8 月',
        '9 月',
        '10 月',
        '11 月',
        '12 月'
    ];

    function filterBy(month, layerName) {
        let filters = ['==', 'month', month];
        map.setFilter(layerName, filters);
        document.getElementById('month').textContent = months[month];
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoianVuaXBlcnRjeSIsImEiOiJjampscjE0c24wOGl3M3ZxZmMyMzlqYTM0In0.cIRNQqr-ygY34X7IrRygyQ';

    let map = new mapboxgl.Map({
        container: 'mapControls',
        style: style,
        center: [138.41095507873092, 35.9738672175538],
        zoom: 5,
        doubleClickZoom: false,
        dragRotate: false,
        touchZoomRotate: true
    });
    map.addControl(new mapboxgl.ScaleControl({
        maxWidth: 200,
        unit: 'metric'
    }));
    map.addControl(new mapboxgl.NavigationControl(), 'bottom-left');


    // Map interactions
    let isSourceLoadedPoints = false;
    map.on('sourcedata', function (sourcedata) {
        if (sourcedata.isSourceLoaded) {
            map.setMinZoom(3);
            map.setMaxZoom(16);
            if (!isSourceLoadedPoints) {
                isSourceLoadedPoints = !isSourceLoadedPoints;
                map.loadImage('assets/css/img/factoryTransp3_selected.png', function (error, image) {
                    if (error) throw error;
                    map.addImage('industry', image);
                    map.addLayer({
                        "id": "points2",
                        "type": "symbol",
                        "interactive": true,
                        "source": {
                            "type": "geojson",
                            "data": canceled_plants
                        },
                        "layout": {
                            "icon-size": 0.18,
                            'icon-ignore-placement': true,
                            'icon-allow-overlap': true
                        }
                    });
                    map.addLayer({
                        "id": "points",
                        "type": "symbol",
                        "interactive": true,
                        "source": {
                            "type": "geojson",
                            "data": plants
                        },
                        "layout": {
                            "icon-image": "industry",
                            "icon-size": 0.08,
                            'icon-ignore-placement': true,
                            'icon-allow-overlap': true
                        }
                    });
                    map.loadImage('assets/css/img/factoryTransp3_red.png', function (error, image) {

                        map.addImage('industry_selected', image);
                        map.addLayer({
                            "id": "points-dblclick",
                            "type": "symbol",
                            "interactive": true,
                            "source": {
                                "type": "geojson",
                                "data": plants
                            },
                            "filter": ["==", "name", ""],
                            "layout": {
                                "icon-image": "industry_selected",
                                "icon-size": 0.08,
                                'icon-ignore-placement': true,
                                'icon-allow-overlap': true
                            }
                        });

                        map.loadImage('assets/css/img/factoryTransp3_green.png', function (error, image) {
                            map.addImage('industry_red', image);
                            map.addLayer({
                                "id": "points-hover",
                                "type": "symbol",
                                "interactive": true,
                                "source": {
                                    "type": "geojson",
                                    "data": plants
                                },
                                "filter": ["==", "name", ""],
                                "layout": {
                                    "icon-image": "industry_red",
                                    "icon-size": 0.08,
                                    'icon-ignore-placement': true,
                                    'icon-allow-overlap': true
                                }
                            });
                            // Add other map event listeners here:
                            map.on("mouseenter", "points", function (e) {
                                map.getCanvas().style.cursor = 'pointer';
                                // d3.select('#title_content').style('display', "block").text(e.features[0].properties.name);
                                // d3.select('#instruction_content').style('display', "block").text(' アイコンをクリックして詳細を表示');
                                // map.setFilter("points-hover", ["==", "name", e.features[0].properties.name]);
                            });
                            map.on("mouseleave", "points", function (e) {
                                map.getCanvas().style.cursor = '';
                                if (state.activeListings.length === 0) {
                                    // d3.select('#title_content').style('display', "block").text('石炭火力発電所をえらぶ');
                                    // d3.select('#instruction_content').style('display', "block").text(' アイコンをクリックして詳細を表示');
                                } else {
                                    // d3.select('#title_content').style('display', "block").text(state.activeListings[state.activeListings.length - 1]);
                                    // d3.select('#instruction_content').style('display', "block").text(' アイコンをクリックして詳細を表示');
                                }
                            });
                            map.on('dblclick', function (e) {
                                isDBLClick = !isDBLClick;
                                let features = map.queryRenderedFeatures(e.point, {layers: ['points']});
                                if (!features.length) {
                                    console.log('[dblclick] clicked map, but not on a icon. No actions.');
                                } else {
                                    setTimeout(function () {
                                        features.forEach(function (f) {
                                            if (state.activePlantIds.has(f.properties.id2)) {
                                                // Delete the selection
                                                state.activeClusterIds.delete(f.properties.cluster);
                                                state.activePlantIds.delete(f.properties.id2);
                                                let index = 0;
                                                state.activeNames.forEach(function (name) {
                                                    if (name === f.properties.name) {
                                                        delete state.activeNames[index];
                                                    }
                                                    // state.activeNames.shift();
                                                    state.activeNames = Array.from(new Set(state.activeNames));
                                                    index += 1;
                                                });
                                            } else {
                                                // Add new selection
                                                state.activeClusterIds.add(f.properties.cluster);
                                                state.activePlantIds.add(f.properties.id2);
                                                state.activeNames.push(f.properties.name);

                                                state.activeListings.shift();
                                                state.activeListings.push(features[0]);
                                            }
                                            state.sizeActiveClusterIds = state.activeClusterIds.size;
                                        });
                                        isDBLClick = false;
                                        console.log("dblclick", state);
                                    }, 300);
                                }
                            });
                            map.on('click', function (e) {
                                let features = map.queryRenderedFeatures(e.point, {layers: ['points']});
                                if (!features.length) {
                                    console.log('[click] clicked map, but not on a icon. No actions.');
                                    console.log(e);
                                } else {
                                    setTimeout(function () {
                                        if (isDBLClick) {
                                            console.log('dbclick (in click)');
                                        } else {
                                            console.log('click (in click)');
                                            redo();
                                            // map.setFilter("points-dblclick", ["==", "name", features[0].properties.name]);
                                            state.activeClusterIds.clear();
                                            state.activePlantIds.clear();
                                            state.activeNames = [];
                                            state.activeListings = [];

                                            features.forEach(function (f) {
                                                state.activeClusterIds.add(f.properties.cluster);
                                                state.activePlantIds.add(f.properties.id2);
                                                state.activeNames.push(f.properties.name);

                                                state.activeListings.shift();
                                                state.activeListings.push(features[0]);
                                            });

                                            if (state.activeClusterIds.size === 1) {
                                                map.setFilter("points-dblclick", ["==", "name", features[0].properties.name]);
                                            } else {
                                                console.log('[ERROR] This should not happen');
                                            }

                                            if (state.activeClusterIds.size === 0) {

                                            } else {
                                                // $('#pm25_button').click();
                                            }
                                            state.sizeActiveClusterIds = state.activeClusterIds.size;
                                            d3.select("#month").text('汚染物質を選択');
                                            console.log("click", state);
                                        }
                                    }, 300);
                                }
                            });
                        });

                    });
                });
            }
        }
    });

</script>

</body>


<script>
    function showInfoWindow(feature) {
        // Rule 1: At any time, there is one and only one activeListings.
        if (state.activeListings.length === 1) {

        } else if (state.activeListings.length === 0) {
            console.log("No state.activeListings; return");
            return;
        } else {
            console.log("[ERROR] this should not happen!");
            return;
        }

        flyToStore(feature);
        createPopUp(feature);
        setTimeout(function () {
            d3.select('#heyThisShouldBeActive').attr('class', 'item active')
        }, 0.001);

        if (state.activeListings.length === 0) {
            map.setFilter("points-hover", ["==", "name", ""]);
        } else {
            map.setFilter("points-hover", ["==", "name", feature.properties.name]);
        }
    }

    function flyToStore(currentFeature) {
        map.flyTo({
            // center: currentFeature.geometry.coordinates,
            // zoom: 8
        });
    }

    function flyToJP22() {
        map.flyTo({
            center: [139.72, 35.214],
            zoom: 8
        });
    }


    function getKmlAndReturnPromise(id, pollutant) {
        return new Promise(resolve =>
            omnivore.kml('dataset/japan' + id + '_' + pollutant + '_concentration_monthly.kml').on('ready', function (d) {
                let sourceName = pollutant + '_' + id;
                let layerName = sourceName + "_layer";
                ls = d.target.getLayers();

                state._id = id;
                state._layerName = layerName;

                for (let i = 0; i < ls.length; ++i) {
                    try {
                        let dd = ls[i].feature;
                        let c_ = [];
                        dd.geometry.coordinates[0].forEach(function (o) {
                            let dropped = _.dropRight(o, 1);
                            c_.push(dropped);
                        });
                        ls[i].feature.geometry.coordinates[0] = c_;
                    } catch (e) {
                        if (ls[i].feature.geometry.type === "Point") {
                            ls[i].feature.geometry.coordinates = ls[i].feature.geometry.coordinates.slice(0, 2);
                        }
                    }
                }
                let pre_data = _.map(ls, 'feature');
                maxConcentration = 0;
                pre_data.map(function (d) {
                    try {
                        d.properties.month = new Date(d.properties.timespan.end).getMonth();
                        if (d.properties.month === 0) {
                            d.properties.month = 11;
                        } else {
                            d.properties.month -= 1;
                        }
                    } catch (e) {
                        d.properties.month = 12;  // always present
                    }
                    try {
                        let color = d3.interpolateLab("#fdbb84", "#7f0000");
                        // console.log('d.properties.name =', d.properties.name);
                        d.properties.color = color(parseFloat(d.properties.name.split(" - ")[0]));
                        if (parseFloat(d.properties.name.split(" - ")[1]) > maxConcentration) {
                            maxConcentration = parseFloat(d.properties.name.split(" - ")[1]);
                        }
                    } catch (e) {
                        console.log(d);
                    }
                    return d;
                });
                state.maxConcentrationDict[sourceName] = maxConcentration;

                console.log("[INFO] sourceName = ", sourceName, " Downloaded!");
                map.addSource(sourceName, {
                    'type': 'geojson',
                    'data': {
                        "type": "FeatureCollection",
                        "features": _.map(ls, 'feature')
                    }
                });
                state.availableSources[pollutant].add(id);
                resolve();
            })
        );
    }

    async function downloadSource(id, pollutant) {
        await getKmlAndReturnPromise(id, pollutant);
    }

    function createPopUp(currentFeature) {
        let id = currentFeature.properties.id2;
        let popUps = document.getElementsByClassName('mapboxgl-popup');

        // Check if there is already a popup on the map and if so, remove it
        if (popUps[0]) {
            popUps[0].remove();
        }

        let popup = new mapboxgl.Popup({closeOnClick: true, closeButton: true})
            .setLngLat(currentFeature.geometry.coordinates)
            .setHTML(
                '<div class="ui grid">' +
                '<div class="sixteen wide column" style="text-align: left; left: 14px; font-weight: bold;">' +
                currentFeature.properties.name + ' (' + currentFeature.properties.prefecture + ')' +
                '</div>' +
                '</div>' +
                '<hr style="border-width: 0.75px;">' +
                '<div class="ui grid">' +
                '<div class="six wide column" style="text-align: center; left: 12px;">' +
                '<div class="row" style="width: 140px; font-size: 11px; position: relative; left: -18px;">' +
                '半径10km圏内の学校と病院' +
                '</div>' +
                '<div class="row" style="width: 120px;">' +
                '<div class="ui mini horizontal divided list" style="font-size: 13px;">' +
                '<div class="item" id="_fa-graduation-cap">' +
                '<i class="fa fa-graduation-cap">' + ' ' + currentFeature.properties.n_schools_within_10km.toString() + ' 校' + '</i>' +
                '</div>' +
                '<div class="item" id="_fa-hospital">' +
                '<i class="fa fa-hospital">' + ' ' + currentFeature.properties.n_hospitals_within_10km.toString() + 'か所' + '</i>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="ten wide stretched column" style="top: 4px; left: -11px;">' +
                '<div class="ui mini three statistics" style="font-size: 12px; width: 105.5%!important;">' +
                '<div class="olive statistic">' +
                '<div class="value">' +
                currentFeature.properties.annual_nox.toFixed(2) +
                '</div>' +
                '<div class="label">' +
                'NO<sub>x</sub><small> (トン/年)</small>' +
                '</div>' +
                '</div>' +
                '<div class="yellow statistic">' +
                '<div class="value">' +
                currentFeature.properties.annual_sox.toFixed(2) +  // TODO!
                '</div>' +
                '<div class="label">' +
                'SO<sub>x</sub><small> (トン/年)</small>' +
                '</div>' +
                '</div>' +
                '<div class="brown statistic">' +
                '<div class="value">' +
                currentFeature.properties.annual_pm.toFixed(2) +  // TODO!
                '</div>' +
                '<div class="label">' +
                'PM2.5<small> (トン/年)</small>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="ui grid">' +
                '<div class="six wide column">' +
                '<div class="ui secondary vertical pointing menu mini" style="font-size: 12px;">' +
                '<a class="item active" id="heyThisShouldBeActive">' +
                '運転開始予定日' +
                '</a>' +
                '<a class="item">' +
                '企業名／運営会社' +
                '</a>' +
                '<a class="item">' +
                '親会社／出資者等' +
                '</a>' +
                '<a class="item">' +
                '燃料' +
                '</a>' +
                '</div>' +
                '</div>' +
                '<div class="ten wide stretched column">' +
                '<div class="ui attached stacked left aligned green segment" id="segment" style="font-size: 12px;">' +
                '<p>' + '運転開始予定: ' + currentFeature.properties.expected_operation_start_date + '; (' + '' + currentFeature.properties.capacity + ')' + '</p>' +

                // '<p>' + currentFeature.properties.status + ' (' + currentFeature.properties.capacity + ')' + '; ' + '運転開始予定: ' + currentFeature.properties.expected_operation_start_date + '</p>' +
                '</div>' +
                '</div>' +
                '</div>'
            )
            .addTo(map);

        let close_button = document.getElementsByClassName('mapboxgl-popup-close-button');
        // close_button[0].className = "className"
        close_button[0].style['display'] = 'block';
        close_button[0].style['margin-top'] = '0px';
        close_button[0].style['color'] = 'black';
        close_button[0].style['font-weight'] = 'bold';
        close_button[0].style['font-size'] = '18px';
        close_button[0].style['z-index'] = 100000;

        popup.on('close', function (e) {
            map.setFilter("points-hover", ["==", "name", ""]);
            // Similar function to watch(state, ["sizeActiveClusterIds"], function () {});
            let filterArray = ["in", "name"];
            Array.from(state.activeNames).forEach(function (name) {
                if (typeof(name) !== 'undefined') {
                    filterArray.push(name);
                }
            });
            map.setFilter("points-dblclick", filterArray);
        });

        $('.ui .item').on('click', function () {
            let expr = this.text;
            if (expr === '運転開始予定日') {
                // d3.select('#segment').text(currentFeature.properties.status + ' (' + currentFeature.properties.capacity + ')' + '; ' + '運転開始予定: ' + currentFeature.properties.expected_operation_start_date);
                d3.select('#segment').text('運転開始予定: ' + currentFeature.properties.expected_operation_start_date + '; (' + '' + currentFeature.properties.capacity + ')');
            } else if (expr === '親会社／出資者等') {
                d3.select('#segment').text(currentFeature.properties.investors);
            } else if (expr === '企業名／運営会社') {
                d3.select('#segment').text(currentFeature.properties.operator);
            } else if (expr === '燃料') {
                d3.select('#segment').text(currentFeature.properties.fuels_used);
            } else {
                return;
            }
            $('.ui .item').removeClass('active');
            $(this).addClass('active');
        });
        d3.selectAll('.ui .item').style('padding', '8px');
        d3.selectAll('#_fa-graduation-cap').style('padding', '6px 6px 0px 6px');
        d3.selectAll('#_fa-hospital').style('padding', '6px 6px 0px 6px');

    }
</script>
<script>
    async function downloadSources(activeLayers) {
        if (state._pollutant === "") {
            return;
        }
        // console.log('=== in downloadSources; activeLayers are ==', activeLayers);
        for (const layer of activeLayers) {
            if (!state.availableSources[state._pollutant].has(layer)) {
                await downloadSource(layer, state._pollutant);
            }
        }
        // console.log('should print later');
    }

    function showActiveLayers(activeLayers) {
        state.existingLayers.forEach(function (o) {
            map.removeLayer(o);
        });
        state.existingLayers = new Set();
        let max_concentration = 0;
        let maxValueHashKey = state._pollutant + objectHash.sha1(activeLayers);

        for (let layer of Array.from(activeLayers)) {
            map.addLayer({
                'id': state._pollutant + "_" + layer + "_layer",
                'type': 'fill',
                "interactive": true,
                'source': state._pollutant + "_" + layer,
                'paint': {
                    'fill-color': {"type": "identity", "property": "color"},
                    'fill-opacity': 0.5,
                    'fill-outline-color': "white"
                }
            });
            state.existingLayers.add(state._pollutant + "_" + layer + "_layer");
            filterBy(0, state._pollutant + "_" + layer + "_layer");  // January  // TODO: change the month sign;

            if (state.maxConcentrationDict[state._pollutant + "_" + layer] > max_concentration) {
                max_concentration = state.maxConcentrationDict[state._pollutant + "_" + layer];
            }
        }

        if (typeof state.maxValue[maxValueHashKey] === "undefined") {
            state.maxValue[maxValueHashKey] = max_concentration;
        } else {
            max_concentration = state.maxValue[maxValueHashKey];
        }
        drawLegend(max_concentration);
    }

    //defining a 'watcher' for an attribute
    watch(state, ["_pollutant"], function () {

        console.log("[Watch::_pollutant] _pollutant changed: ", state._pollutant);
        // console.log('state.existingLayers', state.existingLayers);
        // console.log('state.activeClusterIds', state.activeClusterIds);
        // console.log('state.activeClusterIds.size', state.activeClusterIds.size);
        if (state.activeClusterIds.size > 0) {
            let activeLayers = state.activeClusterIds;
            // console.log('activeLayers', activeLayers);
            d3.select('body').style('cursor', 'progress');
            downloadSources(activeLayers).then(function () {
                showActiveLayers(activeLayers);
                $('#_play_button').removeClass('loading');
                d3.select('body').style('cursor', 'default');
                d3.select('.mapboxgl-canvas').style('cursor', '');
                // d3.select('#select_all_plants').style('display', 'block');
            });
        } else {
            showActiveLayers([]);
            // d3.select("#picker").style("display", "none");
            d3.selectAll('svg').remove();
        }
    });

    // When state.activeClusterIds changed
    // One should change the color of the icons, respectively
    watch(state, ["sizeActiveClusterIds"], function () {
        // console.log('sizeActiveClusterIds changed', state.sizeActiveClusterIds);
        // console.log("activeClusterIds changed to: ", state.activeClusterIds);
        // console.log(Array.from(state.activeNames));
        let filterArray = ["in", "name"];
        Array.from(state.activeNames).forEach(function (name) {
            if (typeof(name) !== 'undefined') {
                filterArray.push(name);
            }
        });
        map.setFilter("points-dblclick", filterArray);
    });

</script>
<script>
    let timer;

    function _blink() {
        d3.select("#month").transition()
            .duration(500)
            .style("color", "rgb(255,255,255)")
            .transition()
            .duration(500)
            .style("color", "rgba(0,0,0,.6)")
            .on("end");
    }

    function play(layerNames) {
        if (state._pollutant === "") {
            _blink();
            return;
        }

        if (!state.is_play) {
            $('#play_button').removeClass('play icon').addClass('pause icon');
            timer = setInterval(function () {
                d3.select("#month").text((state.month % 12).toString());
                layerNames.forEach(function (o) {
                    filterBy(state.month % 12, o);
                });
                state.month += 1;
            }, 500);
        } else {
            $('#play_button').removeClass('pause icon').addClass('play icon');
            clearInterval(timer);
        }
        state.is_play = !state.is_play;
    }

    function playOnMouseover() {
        if (state._pollutant === "") {
            d3.select('#_play_button').style('cursor', 'not-allowed');
        } else {
            d3.select('#_play_button').style('cursor', 'pointer');
        }
    }

    function redo() {
        if (state.is_play) {
            $('#_play_button').click();
            state.month = 0;
        }
        state.is_play = false;
        state.isPollutantSelected = false;  // TODO: maybe not useful at all (maybe others too)
        state.month = 0;
        state._layerName = '';
        state._id = '';

        state.activeClusterIds.clear();
        state.activePlantIds.clear();
        state.activeNames = [];
        state.activeListings = [];
        console.log('[redo] state.sizeActiveClusterIds', state.sizeActiveClusterIds);
        if (state.sizeActiveClusterIds !== 0) {
            // console.log('1');
            state.sizeActiveClusterIds = 0;
            $('#' + state._pollutant + "_button").removeClass('active');
            state._pollutant = '';  // induce the watch function

            // d3.select('#picker').style('display', 'none');
        } else {
            let filterArray = ["in", "name"];
            Array.from(state.activeNames).forEach(function (name) {
                if (typeof(name) !== 'undefined') {
                    filterArray.push(name);
                }
            });
            map.setFilter("points-dblclick", filterArray);
        }

        d3.select("#month").text('石炭火力発電所をえらぶ');


    }


    function dblClickAll() {
        redo();
        plants.features.forEach(function (f) {
            if (state.activeListings.indexOf(f.properties.name) === -1) {
                if (state.activePlantIds.has(f.properties.id2)) {
                    state.activeClusterIds.delete(f.properties.cluster);
                    state.activePlantIds.delete(f.properties.id2);
                    let index = 0;
                    state.activeNames.forEach(function (name) {
                        if (name === f.properties.name) {
                            delete state.activeNames[index];
                        }
                        // state.activeNames.shift();
                        state.activeNames = Array.from(new Set(state.activeNames));
                        index += 1;
                    });
                } else {
                    state.activeClusterIds.add(f.properties.cluster);
                    state.activePlantIds.add(f.properties.id2);
                    state.activeNames.push(f.properties.name);
                }
            }

        });
        state.sizeActiveClusterIds = state.activeClusterIds.size;
        d3.select("#month").text('汚染物質を選択');

    }
</script>
<script>
    function selectPollutant(pollutant) {
        if (!state.activeClusterIds.size) {
            _blink();
            return;
        }


        if (pollutant !== state._pollutant) {
            state._pollutant = pollutant;
            $('#' + pollutant + '_button').addClass('active').siblings().removeClass('active');

            d3.select('.mapboxgl-canvas').style('cursor', 'progress');

            let playButton = $('#_play_button');
            if (state.is_play) {
                playButton.click();
                state.month = 0;
            }
            playButton.addClass('loading');
        }
    }
</script>
<script>
    function drawLegend(max) {
        d3.selectAll('svg').remove();
        d3.select('#mapControls').append('svg');
        let sequentialScale = d3.scaleSequential(d3.interpolateLab("#fdbb84", "#7f0000"))
            .domain([max / 4, max]);

        let svg = d3.select("svg")
            .style("background", "white")
            .style("opacity", 0.9)
            .style("border-radius", "10px")
            .style("border", "2px solid #999999");

        svg.append("g")
            .attr("class", "legendSequential")
            .attr("transform", "translate(10,15)");

        let conc_unit = "濃度 (ppb)";
        if (state._pollutant === "pm25") {
            conc_unit = "濃度 (μg/m³)";
        }
        let legendSequential = d3.legendColor()
            .shapeWidth(30)
            .cells(4)
            .orient("vertical")
            .scale(sequentialScale)
            .title(conc_unit).labels([
                "0 - " + (max / 4).toPrecision(1).toString(),
                (max / 4).toPrecision(1).toString() + " - " + (max * 2 / 4).toPrecision(1).toString(),
                (max * 2 / 4).toPrecision(1).toString() + " - " + (max * 3 / 4).toPrecision(1).toString(),
                "> " + (max * 3 / 4).toPrecision(1).toString()
            ]);

        svg.select(".legendSequential")
            .call(legendSequential);
        svg.style('right', '1vw');
    }
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97327351-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'UA-97327351-2');
</script>

</html>