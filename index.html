<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <title>Japan coal site-by-site map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <script src="node_modules/leaflet/dist/leaflet.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>
    <script src='node_modules/@mapbox/leaflet-omnivore/leaflet-omnivore.min.js'></script>
    <script src='node_modules/jquery/dist/jquery.min.js'></script>

    <link href='assets/css/popup.css' rel='stylesheet'/>
    <link href='assets/css/map.css' rel='stylesheet'/>
    <link href='assets/css/icons.css' rel='stylesheet'/>
    <link href='assets/css/layout.css' rel='stylesheet'/>

    <link href='node_modules/leaflet/dist/leaflet.css' rel='stylesheet'/>

    <script src="assets/js/map_operations.js"></script>
    <script src="assets/js/rgbaToKml/dist/rgbatokml.min.js"></script>
    <script src='node_modules/mapbox-gl/dist/mapbox-gl.js'></script>
    <link href='node_modules/mapbox-gl/dist/mapbox-gl.css' rel='stylesheet'/>
    <script src='assets/js/mapbox-gl-language.js'></script>
    <script src='assets/js/coal_plant_listings.js'></script>
    <script src='assets/js/map_style.js'></script>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
</head>
<body>

<div class='sidebar'>
    <div class='heading'>
        <h1>発電所名</h1>
    </div>
    <div id='listings' class='listings'></div>
</div>

<div id='map' class="map pad2">
    <div class="mapbox-attribution-container">
        <a href="https://www.mapbox.com/about/maps/">© Mapbox | </a>
        <a href="https://www.openstreetmap.org/copyright">© OpenStreetMap | </a>
        <a href="" target="_blank"><strong>Improve this map</strong></a>
    </div>
</div>

<div class='map-overlay' style="z-index: 1001; margin-left: 20%; width: 400px;">
    <div class='map-overlay-inner'>
        <h2>Significant pollutant spread in 2014</h2>
        <label id='month'></label>
        <input id='slider' type='range' min='0' max='11' step='1' value='0'/>
    </div>
    <div class='map-overlay-inner' style="width: 120px;">
        <div id='legend' class='legend' style="width: 110px;">
            <!--<div class='bar'></div>-->
            <div style="color: white; font-weight: bold;">Magnitude (m)</div>
        </div>
    </div>

</div>

<script>

    var months = [
        'January',
        'February',
        'March',
        'April',
        'May',
        'June',
        'July',
        'August',
        'September',
        'October',
        'November',
        'December'
    ];

    function filterBy(month) {

        var filters = ['==', 'month', month];
        map.setFilter('pollution-polygons', filters);
        // map.setFilter('earthquake-labels', filters);

        // Set the label to the month
        document.getElementById('month').textContent = months[month];
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoianVuaXBlcnRjeSIsImEiOiJvOFg5WFVjIn0.7NDB1oOLpq3A5qO7vLaQSA';

    var map = new mapboxgl.Map({
        container: 'map',
        zoomControl: true,
        style: style,
        center: [139.982, 35.4744],
        zoom: 6
    });


    omnivore.kml('dataset/demo/japan30_no2_concentration_monthly.kml').on('ready', function (d) {
        ls = d.target.getLayers();

        for (var i = 0; i < ls.length; ++i) {
            try {
                var dd = ls[i].feature;
                var c_ = [];
                dd.geometry.coordinates[0].forEach(function (o) {
                    var dropped = _.dropRight(o, 1);
                    c_.push(dropped);
                });
                ls[i].feature.geometry.coordinates[0] = c_;
            } catch (e) {
                if (ls[i].feature.geometry.type === "Point") {
                    ls[i].feature.geometry.coordinates = ls[i].feature.geometry.coordinates.slice(0, 2);
                }
            }
        }
        var pre_data = _.map(ls, 'feature');

        pre_data.map(function (d) {
            try {
                d.properties.month = new Date(d.properties.timespan.end).getMonth();
                if (d.properties.month === 0) {
                    d.properties.month = 11;
                } else {
                    d.properties.month -= 1;
                }
            } catch (e) {
                d.properties.month = 12;  // always present
            }
            try {
                d.properties.color = getColor(d.properties.name);
            } catch (e) {
                console.log(d);
            }

            return d;
        });

        console.log(pre_data);
        map.addSource('pollutions', {
            'type': 'geojson',
            'data': {
                "type": "FeatureCollection",
                "features": _.map(ls, 'feature')
            }
        });

        map.addLayer({
            'id': 'pollution-polygons',
            'type': 'fill',
            "interactive": true,
            'source': 'pollutions',
            'paint': {
                'fill-color': { "type": "identity", "property": "color" },
                'fill-opacity': 0.5,
                'fill-outline-color': "white"

            }
        });

        // // This will let you use the .remove() function later on
        // if (!('remove' in Element.prototype)) {
        //     Element.prototype.remove = function () {
        //         if (this.parentNode) {
        //             this.parentNode.removeChild(this);
        //         }
        //     };
        // }

        // Markers
        map.on('load', function () {
            // map.addSource("markers", {
            //     "type": "geojson",
            //     "data": plants
            // });

            map.loadImage('assets/css/img/factoryTransp3.png', function (error, image) {
                if (error) throw error;
                map.addImage('industry', image);
                map.addLayer({
                    "id": "points",
                    "type": "symbol",
                    "interactive": true,
                    "source": {
                        "type": "geojson",
                        "data": plants
                    },
                    "layout": {
                        "icon-image": "industry",
                        "icon-size": 0.25,
                        'icon-allow-overlap': true
                    }
                });


            });
            buildLocationList(plants);

        });


        filterBy(0);  // January

        document.getElementById('slider').addEventListener('input', function (e) {
            var month = parseInt(e.target.value);
            filterBy(month);
        });

        var colors = [];
        for (i = 0; i < pre_data.length; i++) {
            var layer = pre_data[i].properties.name;
            if (colors.length === 3) {
                continue;
            }
            if (layer === "0.05 - 0.1") {
                if (_.indexOf(colors, "#5990e2") === -1) {
                    var color = "#5990e2"
                } else {
                    continue;
                }
            } else if (layer === "0.1 - 0.2") {
                if (_.indexOf(colors, "#FCA107") === -1) {
                    var color = "#FCA107"
                } else {
                    continue;
                }
            } else if (layer === "0.2 - 0.3") {
                if (_.indexOf(colors, "#7f3121") === -1) {
                    var color = "#7f3121"
                } else {
                    continue;
                }
            }
            // var color = kml2hex(pre_data[i].properties.styleHash);
            var item = document.createElement('div');
            var key = document.createElement('div');
            key.className = 'bar';
            key.style.background = color;
            var value = document.createElement('span');
            value.innerHTML = layer;
            item.appendChild(key);
            item.appendChild(value);
            legend.appendChild(item);
            colors.push(color);
        }






    });





    // map.on("render", function () {
    //     if (map.loaded() && map.getStyle().layers.length === 3) {
    //         console.log("render!");
    //         map.on('click', 'points', function (e) {
    //             var features = map.queryRenderedFeatures(e.point, {layers: ['points']});
    //             if (features.length) {
    //                 console.log(features.length);
    //                 var clickedPoint = features[0];
    //                 flyToStore(clickedPoint);
    //                 createPopUp(clickedPoint);
    //                 var activeItem = document.getElementsByClassName('active');
    //                 if (activeItem[0]) {
    //                     activeItem[0].classList.remove('active');
    //                 }
    //                 var selectedFeature = clickedPoint.properties.address;
    //
    //                 for (var i = 0; i < plants.features.length; i++) {
    //                     if (plants.features[i].properties.address === selectedFeature) {
    //                         selectedFeatureIndex = i;
    //                     }
    //                 }
    //                 var listing = document.getElementById('listing-' + selectedFeatureIndex);
    //                 listing.classList.add('active');
    //             }
    //         });
    //
    //         map.on('mouseenter', 'points', function () {
    //             map.getCanvas().style.cursor = 'pointer';
    //         });
    //
    //         map.on('mouseleave', 'points', function () {
    //             map.getCanvas().style.cursor = '';
    //         });
    //
    //         map.off("render", );
    //     }
    // })
    // $(window).bind("load", function() {
    //     // code here
    //     console.log(map.getStyle().layers);
    // });

</script>


</body>
</html>