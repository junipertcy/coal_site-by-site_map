<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'/>
    <title>Japan coal site-by-site map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <script src='node_modules/jquery/dist/jquery.min.js'></script>
    <script src="node_modules/leaflet/dist/leaflet.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>
    <script src='node_modules/mapbox-gl/dist/mapbox-gl.js'></script>
    <script src='node_modules/@mapbox/leaflet-omnivore/leaflet-omnivore.min.js'></script>
    <script src='node_modules/watchjs/src/watch.min.js'></script>

    <!-- Store max value for rendering legends of different layer combinations -->
    <script src="node_modules/object-hash/dist/object_hash.js"></script>

    <script src='node_modules/d3/build/d3.min.js'></script>
    <script src='node_modules/d3-color/build/d3-color.min.js'></script>
    <script src='node_modules/d3-svg-legend/d3-legend.min.js'></script>
    <script src='node_modules/d3-interpolate/build/d3-interpolate.min.js'></script>

    <script src="assets/js/map_operations.js"></script>
    <script src='assets/js/coal_plant_listings_.js'></script>
    <script src='assets/js/map_style.js'></script>

    <link href='assets/css/popup.css' rel='stylesheet'/>
    <link href='assets/css/mapControls.css' rel='stylesheet'/>
    <link href="assets/css/Font-Awesome/web-fonts-with-css/css/fontawesome-all.min.css" rel="stylesheet">

    <link href='node_modules/mapbox-gl/dist/mapbox-gl.css' rel='stylesheet'/>

    <script src='assets/js/semantic/dist/semantic.min.js'></script>

    <link href='assets/js/semantic/dist/semantic.min.css' rel='stylesheet'>

    <script src="assets/js/higherInteraction.js"></script>
    <script src="assets/js/playAndRedo.js"></script>
    <script src="assets/js/selectPollutant.js"></script>
    <script src='assets/js/drawLegend.js'></script>
</head>
<body>


<div style="position: absolute; top: 1vh; right: 1vw; z-index: 10000; background: white; padding: 5px; border-radius: 5px;"
     id="picker">
    <div class="ui mini basic icon buttons">
        <button class="ui button left attached" onclick="selectPollutant('pm25');" id="pm25_button"><i>PM<sub>2.5</sub></i>
        </button>
        <button class="ui button left attached" onclick="selectPollutant('no2');" id="no2_button"><i>NO<sub>2</sub></i>
        </button>
        <button class="ui button left attached" onclick="selectPollutant('so2');" id="so2_button"><i>SO<sub>2</sub></i>
        </button>
        <button class="ui button left attached" id="select_all_plants" onclick="dblClickAll();" data-tooltip="全ての発電所をえらぶ" data-position="bottom center"><i
                class="fa fa-industry"></i></button>
        <button class="ui button right attached" id="show_info_window"
                onclick="showInfoWindow(state.activeListings[0]);" data-tooltip="くわしく見る" data-position="bottom center"><i
                class="fa fa-info"></i></button>
        <button class="ui button right attached" onclick="redo();" data-tooltip="選択を解除する" data-position="bottom center"><i class="fa fa-redo-alt"></i></button>
        <button class="ui compact labeled icon button right attached" onclick="play(state.existingLayers);"
                onmouseenter="playOnMouseover()" id="_play_button">
            <i class="play icon" id="play_button"></i>
            <span id="month">石炭火力発電所をえらぶ</span>
        </button>
    </div>

</div>

<!--汚染物質を選択-->
<main id="mapControls">
    <div class="mapbox-attribution-container">
        <a href="https://www.mapbox.com/about/maps/" target="_blank">© Mapbox | </a>
        <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap | </a>
        <a href="http://www.greenpeace.org/japan/ja/" target="_blank">© Greenpeace Japan</a>
    </div>
</main>

<div class="titleContainer" style="display: none;"></div>
<!--<div class="ui grid" style="width: 378px; height: 70px;" id="toggleContent">-->
<!--<div class="sixteen column row">-->
<!--<div class="fourteen wide column" id="title_content">発電所アイコンの上にマウスをのせる</div>-->
<!--<div class="one floated column" style="z-index: 1000;" onmouseenter="d3.select(this).style('cursor', 'pointer');" onmouseleave="d3.select(this).style('cursor', 'default');" onclick="toogleTitleContent();"><i class="fa fa-minus-square" id="toggleInstructionIcon"></i></div>-->
<!--</div>-->
<!--<div class="row" style="font-size: 11px; bottom: 25px;">-->
<!--<div class="one wide column"></div>-->
<!--<div class="fourteen wide column"><i class="fa fa-angle-double-right" id="instruction_content"> アイコンをクリックして詳細を表示</i></div>-->
<!--</div>-->
<!--</div>-->

<script>
    let months = [
        '1 月',
        '2 月',
        '3 月',
        '4 月',
        '5 月',
        '6 月',
        '7 月',
        '8 月',
        '9 月',
        '10 月',
        '11 月',
        '12 月'
    ];

    function filterBy(month, layerName) {
        let filters = ['==', 'month', month];
        map.setFilter(layerName, filters);
        document.getElementById('month').textContent = months[month];
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoianVuaXBlcnRjeSIsImEiOiJvOFg5WFVjIn0.7NDB1oOLpq3A5qO7vLaQSA';

    let map = new mapboxgl.Map({
        container: 'mapControls',
        style: style,
        center: [138.41095507873092, 35.9738672175538],
        zoom: 5,
        doubleClickZoom: false,
        dragRotate: false,
        touchZoomRotate: true
    });
    map.addControl(new mapboxgl.ScaleControl({
        maxWidth: 200,
        unit: 'metric'
    }));
    map.addControl(new mapboxgl.NavigationControl(), 'bottom-left');


    // Map interactions
    let isSourceLoadedPoints = false;
    map.on('sourcedata', function (sourcedata) {
        if (sourcedata.isSourceLoaded) {
            map.setMinZoom(3);
            map.setMaxZoom(16);
            if (!isSourceLoadedPoints) {
                isSourceLoadedPoints = !isSourceLoadedPoints;
                map.loadImage('assets/css/img/factoryTransp3_selected.png', function (error, image) {
                    if (error) throw error;
                    map.addImage('industry', image);
                    map.addLayer({
                        "id": "points",
                        "type": "symbol",
                        "interactive": true,
                        "source": {
                            "type": "geojson",
                            "data": plants
                        },
                        "layout": {
                            "icon-image": "industry",
                            "icon-size": 0.08,
                            'icon-ignore-placement': true,
                            'icon-allow-overlap': true
                        }
                    });
                    map.loadImage('assets/css/img/factoryTransp3_red.png', function (error, image) {

                        map.addImage('industry_selected', image);
                            map.addLayer({
                                "id": "points-dblclick",
                                "type": "symbol",
                                "interactive": true,
                                "source": {
                                    "type": "geojson",
                                    "data": plants
                                },
                                "filter": ["==", "name", ""],
                                "layout": {
                                    "icon-image": "industry_selected",
                                    "icon-size": 0.08,
                                    'icon-ignore-placement': true,
                                    'icon-allow-overlap': true
                                }
                            });

                        map.loadImage('assets/css/img/factoryTransp3_green.png', function (error, image) {
                            map.addImage('industry_red', image);
                            map.addLayer({
                                "id": "points-hover",
                                "type": "symbol",
                                "interactive": true,
                                "source": {
                                    "type": "geojson",
                                    "data": plants
                                },
                                "filter": ["==", "name", ""],
                                "layout": {
                                    "icon-image": "industry_red",
                                    "icon-size": 0.08,
                                    'icon-ignore-placement': true,
                                    'icon-allow-overlap': true
                                }
                            });
                            // Add other map event listeners here:
                            map.on("mouseenter", "points", function (e) {
                                map.getCanvas().style.cursor = 'pointer';
                                // d3.select('#title_content').style('display', "block").text(e.features[0].properties.name);
                                // d3.select('#instruction_content').style('display', "block").text(' アイコンをクリックして詳細を表示');
                                // map.setFilter("points-hover", ["==", "name", e.features[0].properties.name]);
                            });
                            map.on("mouseleave", "points", function (e) {
                                map.getCanvas().style.cursor = '';
                                if (state.activeListings.length === 0) {
                                    // d3.select('#title_content').style('display', "block").text('石炭火力発電所をえらぶ');
                                    // d3.select('#instruction_content').style('display', "block").text(' アイコンをクリックして詳細を表示');
                                } else {
                                    // d3.select('#title_content').style('display', "block").text(state.activeListings[state.activeListings.length - 1]);
                                    // d3.select('#instruction_content').style('display', "block").text(' アイコンをクリックして詳細を表示');
                                }
                            });
                            map.on('dblclick', function (e) {
                                isDBLClick = !isDBLClick;
                                let features = map.queryRenderedFeatures(e.point, {layers: ['points']});
                                if (!features.length) {
                                    console.log('[dblclick] clicked map, but not on a icon. No actions.');
                                } else {
                                    setTimeout(function(){
                                        features.forEach(function (f) {
                                            if (state.activePlantIds.has(f.properties.id2)) {
                                                // Delete the selection
                                                state.activeClusterIds.delete(f.properties.cluster);
                                                state.activePlantIds.delete(f.properties.id2);
                                                let index = 0;
                                                state.activeNames.forEach(function (name) {
                                                    if (name === f.properties.name) {
                                                        delete state.activeNames[index];
                                                    }
                                                    // state.activeNames.shift();
                                                    state.activeNames = Array.from(new Set(state.activeNames));
                                                    index += 1;
                                                });
                                            } else {
                                                // Add new selection
                                                state.activeClusterIds.add(f.properties.cluster);
                                                state.activePlantIds.add(f.properties.id2);
                                                state.activeNames.push(f.properties.name);

                                                state.activeListings.shift();
                                                state.activeListings.push(features[0]);
                                            }
                                            state.sizeActiveClusterIds = state.activeClusterIds.size;
                                        });
                                        isDBLClick = false;
                                        console.log("dblclick", state);
                                    }, 300);
                                }
                            });
                            map.on('click', function (e) {
                                let features = map.queryRenderedFeatures(e.point, {layers: ['points']});
                                if (!features.length) {
                                    console.log('[click] clicked map, but not on a icon. No actions.');
                                    console.log(e);
                                } else {
                                    setTimeout(function () {
                                        if (isDBLClick) {
                                            console.log('dbclick (in click)');
                                        } else {
                                            console.log('click (in click)');
                                            redo();
                                            // map.setFilter("points-dblclick", ["==", "name", features[0].properties.name]);
                                            state.activeClusterIds.clear();
                                            state.activePlantIds.clear();
                                            state.activeNames = [];
                                            state.activeListings = [];

                                            features.forEach(function (f) {
                                                state.activeClusterIds.add(f.properties.cluster);
                                                state.activePlantIds.add(f.properties.id2);
                                                state.activeNames.push(f.properties.name);

                                                state.activeListings.shift();
                                                state.activeListings.push(features[0]);
                                            });

                                            if (state.activeClusterIds.size === 1) {
                                                map.setFilter("points-dblclick", ["==", "name", features[0].properties.name]);
                                            } else {
                                                console.log('[ERROR] This should not happen');
                                            }

                                            if (state.activeClusterIds.size === 0) {

                                            } else {
                                                // $('#pm25_button').click();
                                            }
                                            state.sizeActiveClusterIds = state.activeClusterIds.size;
                                            d3.select("#month").text('汚染物質を選択');
                                            console.log("click", state);
                                        }
                                    }, 300);
                                }
                            });
                        });

                    });
                });
            }
        }
    });

</script>

</body>



<!--<script>-->
    <!--setTimeout(function(){-->
        <!--flyToJP22();-->
    <!--}, 1000);-->
<!--</script>-->
</html>